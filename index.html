/* ========= CHAPTER 1 SCRIPTS (MESSENGER-VN) ========= */

const Scripts = {
  /* --- MAYA: Scene 1 + Scene 3 + 4 + 5 + 6 intro --- */
  maja: {
    start: { from: 'Maja', text: 'Hey! Guess who texted me today 👀' },
    choices: [
      { id: 'm1', text: "Don't keep me in suspense!" },
      { id: 'm2', text: "Please don't say Riven…" },
      { id: 'm3', text: "Not in the mood, Maya." },
    ],
    replies: {
      m1: [
        { from: 'Maja', text: 'Riven. He texted ME instead of you.' },
        { from: 'Maja', text: "What is he even doing? 😤" },
      ],
      m2: [
        { from: 'Maja', text: '…yeah. Sorry 😅' },
        { from: 'Maja', text: 'He asked if you were still mad.' },
      ],
      m3: [
        { from: 'Maja', text: 'Uh-huh. And yet you’re reading this 👀' },
        { from: 'Maja', text: 'You always want to know, [MC].' },
      ],
    },
    /* Po każdej opcji Maja odblokowuje Rivena */
    effects: {
      m1: [{ unlock: 'riven', notify: true, flag: 'S1_done' }],
      m2: [{ unlock: 'riven', notify: true, flag: 'S1_done' }],
      m3: [{ unlock: 'riven', notify: true, flag: 'S1_done' }],
    },
  },

  /* --- RIVEN: Scene 2 --- */
  riven: {
    start: { from: 'Riven', text: 'You still awake?' },
    choices: [
      { id: 'r1', text: "Didn't expect to hear from you." },
      { id: 'r2', text: "I don't sleep much lately." },
      { id: 'r3', text: "(Don’t reply)" },
    ],
    replies: {
      r1: [
        { from: 'Riven', text: "Me neither. Guess we're both bad at letting go." },
        { from: 'Riven', text: 'Maya said you’re still in town.' },
        { from: 'Riven', text: 'Do you ever think about… that night?' },
      ],
      r2: [
        { from: 'Riven', text: 'Figures. You used to text me at 2AM just to send memes.' },
        { from: 'Riven', text: 'Maya said you’re still in town.' },
        { from: 'Riven', text: 'Do you ever think about… that night?' },
      ],
      r3: [
        { from: 'Riven', text: '…yeah. I probably deserve the silence.' },
        { from: 'Riven', text: 'Maya said you’re still in town.' },
        { from: 'Riven', text: 'Do you ever think about… that night?' },
      ],
    },
    /* drugi wybór w tej scenie — dopiszemy go w silniku jako choices2 */
    followupChoices: [
      { id: 'rfx1', text: 'I try not to.' },
      { id: 'rfx2', text: 'Every day.' },
      { id: 'rfx3', text: 'Delete my number, Riven.' },
    ],
    followupReplies: {
      rfx1: [{ from: 'Riven', text: "I get that. Still, I can't stop." }],
      rfx2: [{ from: 'Riven', text: 'Same. It messes with my head.' }],
      rfx3: [{ from: 'Riven', text: 'Got it. (…Still sorry.)' }],
    },
    effects: {
      // dyskretne punkty relacji (możesz zapisać w stanie)
      r1: [{ rel: { riven: +1 } }],
      r2: [{ rel: { riven: +1 } }],
      r3: [{ rel: { riven: -1 } }],
      rfx1: [{ rel: { riven: +1 }, flag: 'riven_calm' }],
      rfx2: [{ rel: { riven: +1 } }],
      rfx3: [{ rel: { riven: -1 } }],
    },
  },

  /* --- MAYA: Scene 3, 4, 5 (w jednym bloku „post-chat”) --- */
  maja_post: {
    start: { from: 'Maja', text: 'Sooo… he reached out? You okay?' },
    choices: [
      { id: 'mp1', text: "I'm fine. We'll see." },
      { id: 'mp2', text: "He shouldn’t have texted you first." },
      { id: 'mp3', text: "I'm done with him." },
    ],
    replies: {
      mp1: [{ from: 'Maja', text: "That's brave. Closure is healthy. 💪" }],
      mp2: [{ from: 'Maja', text: 'He panics when he can’t control things. Typical.' }],
      mp3: [{ from: 'Maja', text: "Proud of you. He doesn’t deserve another chance." }],
    },
    /* foreshadow: „unknown ping” i „library guy” — bez unlocków */
    after: [
      { from: 'Unknown', text: 'Tomorrow. Café?' },
      { from: 'Maja', text: "Wait—who's that from? You didn't give your number again, right? 😅" },
      { from: 'Maja', text: 'Also… the scanner guy from the library asked about you. Super polite.' },
    ],
    effects: {
      mp1: [{ flag: 'soft' }],
      mp2: [{ flag: 'defensive' }],
      mp3: [{ flag: 'cold' }],
    },
  },

  /* --- NOAH: Scene 6 (odblokuje się tylko po miękkim/neutralnym tonie) --- */
  noah: {
    start: { from: 'Maja', text: 'Heading to that café? Guess who works there! ☕️ Noah!' },
    bridge: { from: 'Noah', text: "Hey! Maya gave me your number—hope that's okay 😅" },
    choices: [
      { id: 'n1', text: 'All good! Nice to hear from you.' },
      { id: 'n2', text: 'Maya loves playing matchmaker.' },
      { id: 'n3', text: "Don't give my number next time, Maya." },
    ],
    replies: {
      n1: [{ from: 'Noah', text: "Awesome! I'll save your usual order ☕️" }],
      n2: [{ from: 'Noah', text: "Haha, guilty. But I'm not complaining." }],
      n3: [{ from: 'Maja', text: 'Oops 😇' }],
    },
    effects: {
      n1: [{ rel: { noah: +1 } }],
      n2: [{ rel: { noah: +1 } }],
      n3: [{ rel: { noah: -1 } }],
    },
  },

  /* --- VICTOR: Scene 7 (wymaga flagi „riven_calm” albo neutralu) --- */
  victor: {
    start: { from: 'Victor', text: 'Good evening. Maja mentioned you like art.' },
    bridge: { from: 'Victor', text: "I have two tickets for Friday’s exhibition. Would you like to come?" },
    choices: [
      { id: 'v1', text: 'That sounds lovely.' },
      { id: 'v2', text: 'You barely know me.' },
      { id: 'v3', text: 'Maybe another time.' },
    ],
    replies: {
      v1: [{ from: 'Victor', text: "Wonderful. I'll send the details tomorrow." }],
      v2: [{ from: 'Victor', text: "Then let's change that." }],
      v3: [{ from: 'Victor', text: 'Of course. No pressure.' }],
    },
    effects: {
      v1: [{ rel: { victor: +1 } }],
      v2: [{ rel: { victor: 0 } }],
      v3: [{ rel: { victor: -1 } }],
    },
  },

  /* --- SCENE 8: End-of-chapter selection (systemowy ekran wyboru) --- */
  end_selector: {
    // tę „scenę” obsłużysz jako osobny ekran z trzema wyborami
    options: [
      { id: 'route_riven',  text: 'Text Riven back.' },
      { id: 'route_noah',   text: "Reply to Noah's invite." },
      { id: 'route_victor', text: "Say yes to Victor's exhibition." },
    ],
  },
};

/* ========= UNLOCK/CONDITION RULES FOR CH1 ========= */

const UnlockRules = {
  startUnlocked: { maja: true, riven: false, noah: false, victor: false },

  // co odblokowuje się po efektach (wywoływane po wyborach)
  applyEffects(effects, state) {
    // state: { unlocked, flags:Set, rel:{riven,noah,victor} }
    for (const eff of effects || []) {
      if (eff.flag) state.flags.add(eff.flag);
      if (eff.unlock) state.unlocked[eff.unlock] = true;
      if (eff.notify) state.badges[eff.unlock] = (state.badges[eff.unlock] || 0) + 1;
      if (eff.rel) {
        for (const k in eff.rel) state.rel[k] = (state.rel[k] || 0) + eff.rel[k];
      }
    }
    return state;
  },

  // logika progresu rozdziału 1 (kiedy pokazać nowe czaty)
  afterChoice(contactId, choiceId, state) {
    // 1) Po odpowiedzi Maji -> odblokuj Riven (już w effects Maji)
    if (contactId === 'maja') {
      state.unlocked.riven = true;
      state.badges.riven = (state.badges.riven || 0) + 1;
    }

    // 2) Po Rivenie (jeśli byłeś spokojna/y) -> później w wątku Maji uruchomimy Noaha/Victora
    // (flagę „riven_calm” nadają effects Rivena)
  },

  // warunki startu Noaha i Victora (wywołaj gdy kończysz Scenę 5 i 6)
  canUnlockNoah(state) {
    // miękki/neutralny ton (brak flagi 'cold')
    return !state.flags.has('cold');
  },
  canUnlockVictor(state) {
    // byłeś spokojna/y wobec Rivena
    return state.flags.has('riven_calm');
  },
};
