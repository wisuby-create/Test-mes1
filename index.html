 <!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Heartline ‚Äî Base + Chapters/CG</title>
<style>
  :root{
    --bg1:#ffeef7; --bg2:#d8efff; --ink:#111827; --muted:#6b7280;
    --glass:rgba(255,255,255,.65); --shadow:0 10px 30px rgba(0,0,0,.25);
    --primary:#ff7aa2; --primary2:#ff96b6; --accent:#4f46e5;
  }
  *{box-sizing:border-box} html,body,#root{height:100%;margin:0}
  body{background:#0f172a;font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto;color:var(--ink);overflow:hidden}
  .stage{height:100%;display:flex;align-items:center;justify-content:center}

  /* phone */
  .phone{
    width:min(360px,calc(100vw - 16px));
    height:min(780px,calc(100vh - 16px));
    border-radius:28px;background:#000;border:4px solid #0b0f1a;
    box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column
  }
  .status{height:56px;display:flex;align-items:center;justify-content:center;background:#0b1220;color:#fff;font-weight:900;position:relative}
  .reset{position:absolute;right:8px;top:8px;border:none;background:#1f2937;color:#fff;border-radius:10px;padding:6px 10px;font-weight:800;cursor:pointer}

  /* screen bg */
  .screen{position:relative;flex:1;overflow:hidden;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
  .screen::before{
    content:"";position:absolute;inset:0;opacity:.22;pointer-events:none;
    background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="700" height="700">\
<defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0" stop-color="#fff"/><stop offset="1" stop-color="#ffffff00"/></radialGradient></defs>\
<g opacity="0.95">\
<circle cx="120" cy="120" r="54" fill="%23f8b4d9"/><circle cx="120" cy="120" r="28" fill="url(%23g)"/>\
<circle cx="560" cy="140" r="46" fill="%23c4b5fd"/><circle cx="560" cy="140" r="24" fill="url(%23g)"/>\
<circle cx="210" cy="320" r="42" fill="%23a7f3d0"/><circle cx="210" cy="320" r="22" fill="url(%23g)"/>\
<circle cx="430" cy="380" r="58" fill="%23fde68a"/><circle cx="430" cy="380" r="30" fill="url(%23g)"/>\
<circle cx="300" cy="560" r="44" fill="%23fbcfe8"/><circle cx="300" cy="560" r="22" fill="url(%23g)"/>\
</g></svg>');
    background-size:280px 280px;background-repeat:repeat
  }
  .wrap{position:relative;z-index:2;height:100%;padding:18px;display:flex;flex-direction:column;align-items:center;justify-content:center}

  /* buttons & cards */
  .title{font-weight:900;font-size:28px;letter-spacing:.5px;margin-bottom:16px;color:#0b1220}
  .subtitle{color:#374151;margin-bottom:24px}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{border:0;border-radius:999px;padding:12px 20px;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
  .btn.ghost{background:rgba(255,255,255,.9);color:#0f172a}
  .btn.link{background:transparent;color:var(--accent);text-decoration:underline}
  .card{background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-radius:18px;padding:18px;box-shadow:var(--shadow);width:90%;max-width:320px}
  .card label{display:block;font-weight:800;margin-bottom:6px}
  .card input{width:100%;padding:12px;border-radius:12px;border:1px solid #d1d5db;font-size:16px}

  /* home icons */
  .home-inner{width:100%;max-width:300px;margin-top:8px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;align-items:start;justify-items:center}
  .app{position:relative;display:flex;flex-direction:column;align-items:center;background:transparent;border:0;cursor:pointer}
  .app-icon{width:68px;height:68px;border-radius:999px;background:rgba(255,255,255,.85);display:grid;place-items:center;box-shadow:0 6px 18px rgba(0,0,0,.12);font-size:28px}
  .app-name{margin-top:6px;font-size:12px;font-weight:700;color:#1f2937}
  .badge{position:absolute;right:-6px;top:-6px;background:#ef4444;color:#fff;border-radius:999px;min-width:18px;height:18px;display:grid;place-items:center;font-size:11px;padding:0 6px;border:2px solid #fff}

  /* messages */
  .messages{height:100%;display:flex;flex-direction:column;position:relative;z-index:1}
  .topbar{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.65);backdrop-filter:blur(6px)}
  .btn-top{background:transparent;border:0;font-size:14px;color:#1f2937;cursor:pointer}
  .list{padding:10px;display:flex;flex-direction:column;gap:10px;height:100%;overflow:auto}
  .contact{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.82);border-radius:14px;padding:10px 12px;text-align:left;position:relative;border:1px solid rgba(0,0,0,.05)}
  .name{font-weight:700}.last{font-size:12px;color:var(--muted)} .badge-row{position:absolute;right:8px;top:8px}
  .initial{width:40px;height:40px;border-radius:999px;display:grid;place-items:center;color:#fff;font-weight:800}
  .i-maja{background:#f472b6} .i-riven{background:#60a5fa} .i-noah{background:#34d399} .i-victor{background:#8b5cf6}
  .initial-sm{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;color:#fff;font-weight:800;font-size:12px}

  .chat{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
  .rowmsg{display:flex;gap:8px;align-items:flex-start}
  .bubble{max-width:76%;padding:9px 11px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
  .from-me{margin-left:auto;background:linear-gradient(135deg,#60a5fa,#4f46e5);color:#fff;border-top-right-radius:6px}
  .from-them{background:#fff;color:var(--ink);border-top-left-radius:6px;border:1px solid rgba(0,0,0,.06)}
  .sender{font-size:11px;font-weight:700;margin-bottom:4px;opacity:.85}
  .nextbar,.choices{padding:10px 12px;background:rgba(255,255,255,.85);border-top:1px solid rgba(0,0,0,.06)}
  .choices{display:grid;gap:8px}
  .choice{padding:10px 12px;border-radius:14px;background:linear-gradient(135deg,#fff,#f5f8ff);border:1px solid rgba(0,0,0,.06);text-align:left;cursor:pointer}

  /* gallery */
  .gallery{padding:14px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .cg{border-radius:12px;overflow:hidden;background:rgba(255,255,255,.85);border:1px solid rgba(0,0,0,.06);padding:10px}
  .cg.locked{filter:grayscale(1);opacity:.6}
  .cg .ttl{font-weight:800;font-size:12px}
  .cg .cap{font-size:11px;color:#6b7280}
</style>
</head>
<body>
<div id="root"></div>

<script>
/* ================== STATE / SAVE ================== */
const SAVE_KEY = 'HL_SAVE_V1';
const ST = {
  playerName: null,
  chapter: 'CH1',
  rel: { riven:0, noah:0, victor:0 },
  flags: {},           // {flag: true}
  cg: {},              // {CG_ID: true}
  unread: {},          // badges per contact
  chats: {             // per contact: {messages:[], queue:[], choices:[], step:'idle'}
    maja:{messages:[],queue:[],choices:[],step:'idle'},
    riven:{messages:[],queue:[],choices:[],step:'idle'},
    noah:{messages:[],queue:[],choices:[],step:'idle'},
    victor:{messages:[],queue:[],choices:[],step:'idle'},
  },
  unlocked: {maja:true, riven:false, noah:false, victor:false},
};
function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(ST)); }
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);
    Object.assign(ST, obj);
    // safety
    ST.flags ||= {}; ST.cg ||= {}; ST.rel ||= {riven:0,noah:0,victor:0};
    ST.unread ||= {}; ST.chats ||= ST.chats;
  }catch(e){ console.warn('bad save', e); }
}
function hardReset(){
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

/* ================== CONTACTS & HELPERS ================== */
const CONTACTS = [
  { id:'maja',   name:'Maya',   color:'i-maja',   initial:'M' },
  { id:'riven',  name:'Riven',  color:'i-riven',  initial:'R' },
  { id:'noah',   name:'Noah',   color:'i-noah',   initial:'N' },
  { id:'victor', name:'Victor', color:'i-victor', initial:'V' },
];
const C = id => CONTACTS.find(c=>c.id===id);

/* ================== CHAPTER CONFIG / SCRIPT ================== */
/** CH1: Maya -> unlock Riven. One CG condition with Riven. */
const SCRIPTS = {
  maja: {
    start: { from:'Maya', text:'Hey! Guess who texted me today üëÄ' },
    choices: [
      { id:'m1', text:"Don‚Äôt keep me in suspense!" },
      { id:'m2', text:"Please don‚Äôt say‚Ä¶ Riven." },
      { id:'m3', text:"Not in the mood, Maya." },
    ],
    replies: {
      m1: [
        { from:'Maya', text:'Riven. He texted ME instead of you.' },
        { from:'Maya', text:'What is he even doing? üò§' },
      ],
      m2: [
        { from:'Maya', text:'‚Ä¶yeah. Sorry üòÖ' },
        { from:'Maya', text:'He asked if you were still mad.' },
      ],
      m3: [
        { from:'Maya', text:'Uh-huh. And yet you‚Äôre reading this üëÄ' },
        { from:'Maya', text:`You always want to know, ${'${name}'}.` },
      ],
    },
    effects: {
      m1: [{unlock:'riven', notify:true, flag:'S1_TOLD', step:'S1_END'}],
      m2: [{unlock:'riven', notify:true, flag:'S1_TOLD', step:'S1_END'}],
      m3: [{unlock:'riven', notify:true, flag:'S1_TOLD', step:'S1_END'}],
    },
  },
  riven: {
    start: { from:'Riven', text:'You still awake?' },
    choices: [
      { id:'r1', text:"Didn‚Äôt expect to hear from you." },
      { id:'r2', text:"I don‚Äôt sleep much lately." },
      { id:'r3', text:"(Don‚Äôt reply)" },
    ],
    replies: {
      r1: [
        { from:'Riven', text:"Me neither. Guess we‚Äôre both bad at letting go." },
        { from:'Riven', text:'Maya said you‚Äôre still in town.' },
        { from:'Riven', text:'Do you ever think about‚Ä¶ that night?' },
      ],
      r2: [
        { from:'Riven', text:'Figures. You used to text me at 2AM just to send memes.' },
        { from:'Riven', text:'Maya said you‚Äôre still in town.' },
        { from:'Riven', text:'Do you ever think about‚Ä¶ that night?' },
      ],
      r3: [
        { from:'Riven', text:'‚Ä¶yeah. I probably deserve the silence.' },
        { from:'Riven', text:'Maya said you‚Äôre still in town.' },
        { from:'Riven', text:'Do you ever think about‚Ä¶ that night?' },
      ],
    },
    followupChoices: [
      { id:'rfx1', text:'I try not to.' },
      { id:'rfx2', text:'Every day.' },
      { id:'rfx3', text:'Delete my number, Riven.' },
    ],
    followupReplies: {
      rfx1: [{ from:'Riven', text:"I get that. Still, I can‚Äôt stop." }],
      rfx2: [{ from:'Riven', text:'Same. It messes with my head.' }],
      rfx3: [{ from:'Riven', text:'Got it. (‚Ä¶Still sorry.)' }],
    },
    effects: {
      r1: [{rel:{riven:+1}}],
      r2: [{rel:{riven:+1}}],
      r3: [{rel:{riven:-1}}],
      rfx1: [{rel:{riven:+1}, flag:'RIVEN_OPENED'}],
      rfx2: [{rel:{riven:+1}, flag:'RIVEN_OPENED'}],
      rfx3: [{rel:{riven:-1}}],
    },
  },
};

/** CG registry: conditions decide unlocks */
const CGS = {
  CG_RIVEN_01: {
    title:'Moonlit Bridge',
    caption:'Riven opens up a little.',
    condition: () => ST.rel.riven >= 2 && !!ST.flags.RIVEN_OPENED,
  },
};

/** Chapter gating */
const CHAPTERS = {
  CH1: {
    name:'Chapter 1',
    unlockedContacts: {maja:true, riven:()=>!!ST.flags.S1_TOLD},
    endCondition: () => ST.flags.RIVEN_OPENED || ST.rel.riven<=-1,
    onEnd: () => { ST.chapter='CH2'; },
  },
  CH2: {
    name:'Chapter 2',
    // placeholder ‚Äì ready for future scripts
  }
};

/* ================== UI BUILDERS ================== */
const root = document.getElementById('root');
function mount(node){ phone.replaceChildren(StatusBar(), node); }
function StatusBar(){
  const el=document.createElement('div');
  el.className='status';
  el.textContent = 'Heartline';
  const btn=document.createElement('button');
  btn.className='reset'; btn.textContent='‚ü≤ Reset';
  btn.onclick=hardReset;
  el.appendChild(btn);
  return el;
}
function StartScreen(){
  const s=document.createElement('div'); s.className='screen';
  const w=document.createElement('div'); w.className='wrap';
  w.innerHTML=`<div class="title">Heartline</div>
               <div class="subtitle">Romance ‚Ä¢ Mystery ‚Ä¢ Choices</div>
               <div class="row">
                 <button class="btn primary" id="startBtn">Start</button>
                 <button class="btn ghost" id="resetBtn">Reset</button>
               </div>`;
  s.appendChild(w);
  w.querySelector('#startBtn').onclick=()=>mount(NameScreen());
  w.querySelector('#resetBtn').onclick=hardReset;
  return s;
}
function NameScreen(){
  const s=document.createElement('div'); s.className='screen';
  const w=document.createElement('div'); w.className='wrap';
  w.innerHTML=`<div class="card">
      <label>Enter your name</label>
      <input id="nm" placeholder="Your name‚Ä¶" maxlength="16"/>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn primary" id="ok">OK</button>
      </div>
    </div>`;
  s.appendChild(w);
  setTimeout(()=>w.querySelector('#nm')?.focus(),50);
  w.querySelector('#ok').onclick=()=>{
    ST.playerName = (w.querySelector('#nm').value||'Player').trim();
    save(); mount(HomeScreen());
  };
  return s;
}
function HomeScreen(){
  // compute total unread
  const totalUnread = Object.values(ST.unread).reduce((a,b)=>a+(b||0),0);
  const s=document.createElement('div'); s.className='screen';
  const w=document.createElement('div'); w.className='wrap';
  w.style.justifyContent='flex-start'; w.style.paddingTop='24px';
  w.innerHTML=`<div style="font-weight:900;margin-bottom:10px">Welcome, ${ST.playerName||'Player'} üíñ ‚Äî ${CHAPTERS[ST.chapter]?.name||''}</div>
    <div class="home-inner">
      <div class="grid">
        <button class="app" id="appMessages"><div class="app-icon">üí¨</div><div class="app-name">Messages</div><div class="badge" id="badgeM" style="${totalUnread?'':'display:none'}">${totalUnread||1}</div></button>
        <button class="app" id="appPhone"><div class="app-icon">üìû</div><div class="app-name">Phone</div></button>
        <button class="app" id="appGallery"><div class="app-icon">üñºÔ∏è</div><div class="app-name">Gallery</div></button>
        <button class="app"><div class="app-icon">‚è∞</div><div class="app-name">Clock</div></button>
        <button class="app" id="appSettings"><div class="app-icon">‚öôÔ∏è</div><div class="app-name">Settings</div></button>
        <button class="app"><div class="app-icon">üìù</div><div class="app-name">Notes</div></button>
      </div>
    </div>`;
  s.appendChild(w);
  w.querySelector('#appMessages').onclick=()=>mount(MessagesList());
  w.querySelector('#appGallery').onclick=()=>mount(GalleryView());
  w.querySelector('#appSettings').onclick=()=>mount(SettingsView());
  return s;
}
function BackTop(title, onBack){
  const el=document.createElement('div'); el.className='topbar';
  el.innerHTML=`<button class="btn-top" id="b">‚óÄÔ∏é</button><div style="font-weight:700">${title}</div><div style="width:24px"></div>`;
  el.querySelector('#b').onclick=onBack;
  return el;
}

/* ---------- Messages Module ---------- */
function visibleContacts(){
  const conf = CHAPTERS[ST.chapter];
  const arr = [];
  for(const c of CONTACTS){
    const rule = conf?.unlockedContacts?.[c.id];
    const ok = typeof rule==='function' ? rule() : !!rule || !!ST.unlocked[c.id];
    if(ok) arr.push(c);
  }
  return arr;
}
function lastPreview(id){
  const m = ST.chats[id]?.messages||[];
  if(m.length) return m[m.length-1].text;
  const s = SCRIPTS[id]?.start?.text;
  return s || '';
}
function MessagesList(){
  const s=document.createElement('div'); s.className='screen';
  const box=document.createElement('div'); box.className='messages';
  box.appendChild(BackTop('Messages', ()=>mount(HomeScreen())));
  const list=document.createElement('div'); list.className='list';

  for(const c of visibleContacts()){
    const row=document.createElement('button'); row.className='contact'; row.onclick=()=>openChat(c.id);
    row.innerHTML=`<div class="initial ${c.color}">${c.initial}</div>
                   <div><div class="name">${c.name}</div><div class="last">${lastPreview(c.id)}</div></div>`;
    if(ST.unread[c.id]){ const b=document.createElement('div'); b.className='badge badge-row'; b.textContent=ST.unread[c.id]; row.appendChild(b); }
    list.appendChild(row);
  }
  box.appendChild(list); s.appendChild(box); return s;
}
function openChat(id){
  ensureStart(id);
  ST.unread[id]=0; save();
  mount(ChatView(id));
}
function ensureStart(id){
  const ch = ST.chats[id];
  if(!ch.messages.length && !ch.queue.length){
    const s = SCRIPTS[id]?.start; if(s) ch.queue.push({from:s.from,text:s.text,me:false});
    ch.step='started';
  }
}
function ChatView(id){
  const c = C(id);
  const s=document.createElement('div'); s.className='screen';
  const box=document.createElement('div'); box.className='messages';
  box.appendChild(BackTop(c.name, ()=>mount(MessagesList())));

  const log=document.createElement('div'); log.className='chat';
  ST.chats[id].messages.forEach(renderMsg);
  box.appendChild(log);

  function renderMsg(m){
    const row=document.createElement('div'); row.className='rowmsg';
    row.style.justifyContent = m.me?'flex-end':'flex-start';
    if(!m.me){
      const av=document.createElement('div'); av.className='initial-sm '+c.color; av.textContent=(m.from||'?')[0]; row.appendChild(av);
    }
    const b=document.createElement('div'); b.className='bubble '+(m.me?'from-me':'from-them');
    b.innerHTML=`<div class="sender">${m.me?'You':m.from}</div><div>${m.text}</div>`;
    row.appendChild(b);
    if(m.me){ const me=document.createElement('div'); me.className='initial-sm i-maja'; me.textContent='Y'; row.appendChild(me); }
    log.appendChild(row);
    log.scrollTop = log.scrollHeight;
  }

  const barNext=document.createElement('div'); barNext.className='nextbar';
  const btnNext=document.createElement('button'); btnNext.className='choice'; btnNext.textContent='Next ‚ñ∂';
  btnNext.onclick=()=>{ stepNext(); refresh(); };
  barNext.appendChild(btnNext);

  const barChoices=document.createElement('div'); barChoices.className='choices';

  function stepNext(){
    const ch = ST.chats[id];
    if(!ch.queue.length) return;
    const msg = ch.queue.shift();
    ch.messages.push(msg);
    if(!ch.queue.length && ch.step==='started'){
      ch.choices = SCRIPTS[id]?.choices||[];
      ch.step='await';
    }
    save();
  }
  function pick(choiceId){
    const sc = SCRIPTS[id];
    const ch = ST.chats[id];
    const pick = (sc.choices||[]).find(x=>x.id===choiceId);
    ch.messages.push({from:'You',text:pick.text,me:true});
    ch.choices=[];
    // enqueue replies
    (sc.replies?.[choiceId]||[]).forEach(m=>ch.queue.push(m));
    // apply effects
    applyEffects(sc.effects?.[choiceId]||[]);
    // special follow-up for Riven
    if(id==='riven'){ ch.step='after1'; }
    save(); refresh();
  }
  function rivenFollowList(){
    const sc=SCRIPTS.riven;
    barChoices.replaceChildren();
    for(const opt of sc.followupChoices){
      const b=document.createElement('button'); b.className='choice'; b.textContent=opt.text;
      b.onclick=()=>rivenFollowPick(opt.id, opt.text);
      barChoices.appendChild(b);
    }
  }
  function rivenFollowPick(optId, myText){
    const ch = ST.chats.riven;
    ch.messages.push({from:'You',text:myText,me:true});
    (SCRIPTS.riven.followupReplies[optId]||[]).forEach(m=>ch.queue.push(m));
    applyEffects(SCRIPTS.riven.effects?.[optId]||[]);
    save(); refresh();
  }
  function refresh(){
    // re-render log quickly (simple approach)
    log.replaceChildren();
    ST.chats[id].messages.forEach(renderMsg);

    // decide bottom bar
    const ch = ST.chats[id];
    // after Riven first wave, show follow-up choices
    if(id==='riven' && ch.queue.length===0 && ch.choices.length===0 && ch.messages.length>0 && ch.step==='after1'){
      rivenFollowList();
      box.replaceChildren(BackTop(c.name, ()=>mount(MessagesList())), log, barChoices);
      return;
    }
    if(ch.queue.length>0){
      box.replaceChildren(BackTop(c.name, ()=>mount(MessagesList())), log, barNext);
    }else{
      // if no queue and no choices, try to open choices (first time) or end-of-thread
      if(ch.step==='await' && (!ch.choices || !ch.choices.length)){
        ch.choices = SCRIPTS[id]?.choices||[];
      }
      barChoices.replaceChildren();
      if(ch.choices && ch.choices.length){
        for(const opt of ch.choices){
          const b=document.createElement('button'); b.className='choice'; b.textContent=opt.text;
          b.onclick=()=>pick(opt.id);
          barChoices.appendChild(b);
        }
      }else{
        // nothing to do -> end? check chapter end
        maybeEndChapter();
        const info=document.createElement('div'); info.style.cssText='font-size:12px;color:#6b7280';
        info.textContent='No choices ‚Äî wait for new message';
        barChoices.appendChild(info);
      }
      box.replaceChildren(BackTop(c.name, ()=>mount(MessagesList())), log, barChoices);
    }
  }

  refresh();
  return s;
}

/* ---------- Effects, CG unlocks, chapter end ---------- */
function applyEffects(effects){
  for(const eff of effects){
    if(eff.flag) ST.flags[eff.flag]=true;
    if(eff.unlock){
      ST.unlocked[eff.unlock]=true;
      ST.unread[eff.unlock]=(ST.unread[eff.unlock]||0)+1;
    }
    if(eff.rel){
      for(const k in eff.rel){ ST.rel[k]=(ST.rel[k]||0)+eff.rel[k]; }
    }
  }
  // evaluate CG conditions after any effect
  for(const id in CGS){
    if(!ST.cg[id] && CGS[id].condition()){
      ST.cg[id]=true;
      ST.unread.gallery = (ST.unread.gallery||0)+1; // badge for gallery
    }
  }
  save();
}
function maybeEndChapter(){
  const ch = CHAPTERS[ST.chapter];
  if(ch?.endCondition && ch.endCondition()){
    ch.onEnd && ch.onEnd();
    save();
  }
}

/* ---------- Gallery ---------- */
function GalleryView(){
  const s=document.createElement('div'); s.className='screen';
  const top=BackTop('Gallery', ()=>mount(HomeScreen()));
  const grid=document.createElement('div'); grid.className='gallery';

  for(const id in CGS){
    const unlocked = !!ST.cg[id];
    const card=document.createElement('div'); card.className='cg'+(unlocked?'':' locked');
    card.innerHTML = `<div class="ttl">${CGS[id].title}</div>
      <div class="cap">${unlocked?CGS[id].caption:'Locked ‚Äî meet the conditions.'}</div>`;
    grid.appendChild(card);
  }

  s.appendChild(top); s.appendChild(grid); return s;
}

/* ---------- Settings + Debug / Flowchart ---------- */
function SettingsView(){
  const s=document.createElement('div'); s.className='screen';
  const w=document.createElement('div'); w.className='wrap';
  const relTxt = `Riven ${ST.rel.riven>=0?'+':''}${ST.rel.riven} | Noah ${ST.rel.noah>=0?'+':''}${ST.rel.noah} | Victor ${ST.rel.victor>=0?'+':''}${ST.rel.victor}`;
  const flagsTxt = Object.keys(ST.flags).sort().join(', ')||'‚Äî';
  const cgTxt = Object.keys(ST.cg).sort().join(', ')||'‚Äî';
  w.innerHTML=`<div class="title">Settings</div>
               <div class="subtitle" style="max-width:300px;text-align:center">
                 Player: <b>${ST.playerName||'Player'}</b><br/>
                 Chapter: <b>${ST.chapter}</b><br/>
                 Relations: <b>${relTxt}</b><br/>
                 Flags: <b>${flagsTxt}</b><br/>
                 CG: <b>${cgTxt}</b>
               </div>
               <div class="row">
                 <button class="btn primary" id="dbg">Flowchart / Debug</button>
                 <button class="btn ghost" id="home">Back</button>
               </div>`;
  s.appendChild(w);
  w.querySelector('#home').onclick=()=>mount(HomeScreen());
  w.querySelector('#dbg').onclick=()=>mount(FlowchartView());
  return s;
}
function FlowchartView(){
  const s=document.createElement('div'); s.className='screen';
  const top=BackTop('Flowchart / Debug', ()=>mount(SettingsView()));
  const wrap=document.createElement('div'); wrap.className='wrap'; wrap.style.alignItems='stretch';
  wrap.style.justifyContent='flex-start'; wrap.style.paddingTop='10px';

  const pre=document.createElement('pre'); pre.style.cssText='background:rgba(255,255,255,.9);padding:12px;border-radius:12px;max-width:320px;white-space:pre-wrap';
  pre.textContent = renderFlowchart();
  wrap.appendChild(pre);
  s.appendChild(top); s.appendChild(wrap); return s;
}
function renderFlowchart(){
  function block(id){
    const sc=SCRIPTS[id]; if(!sc) return '';
    let out = `„Äê${id.toUpperCase()}„Äë\n`;
    out += `start: ${sc.start?.from}: "${sc.start?.text}"\nchoices:\n`;
    for(const ch of sc.choices||[]){ out += `  - ${ch.id}: "${ch.text}"\n`; }
    out += `replies:\n`;
    for(const k in sc.replies){
      out += `  ${k}:\n`;
      for(const r of sc.replies[k]) out += `    ‚Ä¢ ${r.from}: "${r.text}"\n`;
    }
    if(sc.followupChoices){
      out += `follow-up choices:\n`;
      for(const ch of sc.followupChoices) out += `  - ${ch.id}: "${ch.text}"\n`;
    }
    if(sc.effects){
      out += `effects:\n`;
      for(const key in sc.effects){
        const arr=sc.effects[key];
        out += `  ${key}: ${JSON.stringify(arr)}\n`;
      }
    }
    return out+'\n';
  }
  let txt = `Heartline ‚Äî Script Overview (Chapter ${ST.chapter})\n\n`;
  txt += block('maja');
  txt += block('riven');
  txt += `CG conditions:\n`;
  for(const id in CGS){
    txt += `  ${id}: ${CGS[id].title} ‚Äî unlocks when condition() returns true.\n`;
  }
  return txt;
}

/* ================== BOOT ================== */
const phone=document.createElement('div'); phone.className='phone'; root.appendChild(phone);
function startApp(){
  load();
  if(!ST.playerName) mount(StartScreen());
  else mount(HomeScreen());
}
startApp();
</script>
</body>
</html>
