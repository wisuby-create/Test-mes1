<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Heartline ‚Äî Demo</title>
<style>
  :root{
    --bg1:#ffeef7; --bg2:#e6f0ff; --ink:#111827; --muted:#6b7280;
    --glass:rgba(255,255,255,.65); --shadow:0 10px 30px rgba(0,0,0,.25);
    --blue:#60a5fa; --vio:#8b5cf6; --green:#34d399; --pink:#f472b6;
  }
  *{box-sizing:border-box} html,body,#root{height:100%;margin:0}
  body{background:#0f172a;overflow:hidden;font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto;color:var(--ink)}
  .stage{height:100%;display:flex;align-items:center;justify-content:center}
  /* phone shell */
  .phone{
    width:min(360px,calc(100vw - 16px));
    height:min(780px,calc(100vh - 16px));
    border-radius:28px;background:#000;border:4px solid #0b0f1a;
    box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column
  }
  .appbar{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:#0b1220;color:#fff}
  .appbar b{font-weight:700}
  .btn-top{background:#182034;border:0;color:#e5e7eb;border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
  /* wallpaper */
  .screen{position:relative;flex:1;overflow:hidden;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
  .screen::before{
    content:"";position:absolute;inset:0;opacity:.22;
    background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="700" height="700">\
<defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0" stop-color="#fff"/><stop offset="1" stop-color="#ffffff00"/></radialGradient></defs>\
<g opacity="0.95">\
<circle cx="120" cy="120" r="54" fill="%23f8b4d9"/><circle cx="120" cy="120" r="28" fill="url(%23g)"/>\
<circle cx="560" cy="140" r="46" fill="%23c4b5fd"/><circle cx="560" cy="140" r="24" fill="url(%23g)"/>\
<circle cx="210" cy="320" r="42" fill="%23a7f3d0"/><circle cx="210" cy="320" r="22" fill="url(%23g)"/>\
<circle cx="430" cy="380" r="58" fill="%23fde68a"/><circle cx="430" cy="380" r="30" fill="url(%23g)"/>\
<circle cx="300" cy="560" r="44" fill="%23fbcfe8"/><circle cx="300" cy="560" r="22" fill="url(%23g)"/>\
</g></svg>');
    background-size:280px 280px;background-repeat:repeat
  }
  /* START */
  .start-wrap{height:100%;display:grid;place-items:center;padding:18px}
  .card{background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-radius:22px;box-shadow:var(--shadow);padding:22px; text-align:center; width:min(320px,90%)}
  .title{font-size:28px;font-weight:800;letter-spacing:.5px;margin-bottom:10px}
  .btn-primary{background:linear-gradient(135deg,#fb7185,#f472b6);color:#fff;border:0;border-radius:14px;padding:12px 16px;font-weight:700;cursor:pointer;width:100%;margin-top:10px}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:10px 12px;cursor:pointer;width:100%;margin-top:8px}
  /* NAME */
  .name-box input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,.12);font-size:16px}
  /* HOME */
  .home{position:relative;z-index:1;padding:18px;height:100%;display:flex;flex-direction:column}
  .welcome{margin:4px 0 12px 4px;color:#1f2937;font-weight:700}
  .grid{flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:18px;align-items:start;justify-items:center}
  .app{position:relative;display:flex;flex-direction:column;align-items:center}
  .app-icon{width:68px;height:68px;border-radius:999px;background:var(--glass);backdrop-filter:blur(6px);display:grid;place-items:center;box-shadow:0 6px 18px rgba(0,0,0,.12);font-size:26px}
  .app-name{margin-top:6px;font-size:12px;font-weight:600;color:#1f2937}
  .badge{position:absolute;right:-6px;top:-6px;background:#ef4444;color:#fff;border-radius:999px;min-width:18px;height:18px;display:grid;place-items:center;font-size:11px;padding:0 6px;border:2px solid #fff}
  .home-hint{text-align:center;font-size:12px;color:#374151}
  /* MESSAGES LIST */
  .messages{height:100%;display:flex;flex-direction:column;position:relative;z-index:1}
  .topbar{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.65);backdrop-filter:blur(6px)}
  .btn{background:transparent;border:0;font-size:14px;color:#1f2937;cursor:pointer}
  .list{padding:10px;display:flex;flex-direction:column;gap:10px;height:100%;overflow:auto}
  .contact{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.82);border-radius:14px;padding:10px 12px;text-align:left;position:relative;border:1px solid rgba(0,0,0,.06)}
  .name{font-weight:700}.last{font-size:12px;color:var(--muted)} .badge-row{position:absolute;right:8px;top:8px}
  /* avatars (initials) */
  .initial{width:40px;height:40px;border-radius:999px;display:grid;place-items:center;color:#fff;font-weight:800}
  .i-maja{background:var(--pink)} .i-riven{background:var(--blue)} .i-noah{background:var(--green)} .i-victor{background:var(--vio)}
  .initial-sm{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;color:#fff;font-weight:800;font-size:12px}
  /* CHAT */
  .chat{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
  .rowmsg{display:flex;gap:8px;align-items:flex-start}
  .bubble{max-width:76%;padding:9px 11px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
  .from-me{margin-left:auto;background:linear-gradient(135deg,#60a5fa,#4f46e5);color:#fff;border-top-right-radius:6px}
  .from-them{background:#fff;color:var(--ink);border-top-left-radius:6px;border:1px solid rgba(0,0,0,.06)}
  .sender{font-size:11px;font-weight:700;margin-bottom:4px;opacity:.85}
  .nextbar{padding:10px 12px;background:rgba(255,255,255,.85);border-top:1px solid rgba(0,0,0,.06);display:flex;justify-content:flex-end}
  .choices{padding:10px 12px;background:rgba(255,255,255,.85);border-top:1px solid rgba(0,0,0,.06);display:grid;gap:8px}
  .choice{padding:10px 12px;border-radius:14px;background:linear-gradient(135deg,#fff,#f5f8ff);border:1px solid rgba(0,0,0,.06);text-align:left;cursor:pointer}
</style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const {useState,useEffect}=React;

/* ---------- STATE & SAVE ---------- */
function newChat(){return{messages:[],pending:[],choices:[],seeded:false,introDone:false,followDone:false};}
function makeState(){
  return{
    screen:'start',                  // 'start' | 'name' | 'home' | 'messages' | 'chat'
    current:null,
    playerName:'',
    unlocked:{maja:true,riven:false,noah:false,victor:false},
    unread:{},
    flags:{},
    rel:{riven:0,noah:0,victor:0},
    chats:{maja:newChat(),riven:newChat(),noah:newChat(),victor:newChat()}
  };
}
const SAVEKEY='HL_SAVE_V2';
let ST=JSON.parse(localStorage.getItem(SAVEKEY)||'null')||makeState();
function save(){localStorage.setItem(SAVEKEY,JSON.stringify(ST));}
function hardReset(){localStorage.removeItem(SAVEKEY);location.reload();}

/* ---------- SCRIPTS (CH1 excerpt) ---------- */
const Scripts={
  maja:{
    start:{from:'Maya',text:'Hey! Guess who texted me today üëÄ'},
    choices:[
      {id:'m1',text:"Don't keep me in suspense!"},
      {id:'m2',text:"Please don't say Riven‚Ä¶"},
      {id:'m3',text:"Not in the mood, Maya."},
    ],
    replies:{
      m1:[{from:'Maya',text:'Riven. He texted ME instead of you.'},{from:'Maya',text:"What is he even doing? üò§"}],
      m2:[{from:'Maya',text:'‚Ä¶yeah. Sorry üòÖ'},{from:'Maya',text:'He asked if you were still mad.'}],
      m3:[{from:'Maya',text:'Uh-huh. And yet you‚Äôre reading this üëÄ'},{from:'Maya',text:'You always want to know, [MC].'}],
    },
    effects:{
      m1:[{unlock:'riven'}],
      m2:[{unlock:'riven'}],
      m3:[{unlock:'riven'}],
    },
  },
  riven:{
    start:{from:'Riven',text:'You still awake?'},
    choices:[
      {id:'r1',text:"Didn't expect to hear from you."},
      {id:'r2',text:"I don't sleep much lately."},
      {id:'r3',text:"(Don‚Äôt reply)"},
    ],
    replies:{
      r1:[{from:'Riven',text:"Me neither. Guess we're both bad at letting go."},{from:'Riven',text:'Maya said you‚Äôre still in town.'},{from:'Riven',text:'Do you ever think about‚Ä¶ that night?'}],
      r2:[{from:'Riven',text:'Figures. You used to text me at 2AM just to send memes.'},{from:'Riven',text:'Maya said you‚Äôre still in town.'},{from:'Riven',text:'Do you ever think about‚Ä¶ that night?'}],
      r3:[{from:'Riven',text:'‚Ä¶yeah. I probably deserve the silence.'},{from:'Riven',text:'Maya said you‚Äôre still in town.'},{from:'Riven',text:'Do you ever think about‚Ä¶ that night?'}],
    },
    followupChoices:[
      {id:'rfx1',text:'I try not to.'},
      {id:'rfx2',text:'Every day.'},
      {id:'rfx3',text:'Delete my number, Riven.'},
    ],
    followupReplies:{
      rfx1:[{from:'Riven',text:"I get that. Still, I can't stop."}],
      rfx2:[{from:'Riven',text:'Same. It messes with my head.'}],
      rfx3:[{from:'Riven',text:'Got it. (‚Ä¶Still sorry.)'}],
    },
    effects:{
      r1:[{rel:{riven:+1}}], r2:[{rel:{riven:+1}}], r3:[{rel:{riven:-1}}],
      rfx1:[{rel:{riven:+1}}], rfx2:[{rel:{riven:+1}}], rfx3:[{rel:{riven:-1}}],
    }
  }
};
function unlock(id){ if(!ST.unlocked[id]) ST.unlocked[id]=true; ST.unread[id]=(ST.unread[id]||0)+1; }
function applyEffects(list=[]){
  list.forEach(e=>{
    if(e.unlock) unlock(e.unlock);
    if(e.rel){ for(const k in e.rel){ ST.rel[k]=(ST.rel[k]||0)+e.rel[k]; } }
    if(e.flag) ST.flags[e.flag]=true;
  });
  save();
}

/* ---------- CONTACTS ---------- */
const CONTACTS=[
  {id:'maja',name:'Maya',color:'i-maja',initial:'M'},
  {id:'riven',name:'Riven',color:'i-riven',initial:'R'},
  {id:'noah',name:'Noah',color:'i-noah',initial:'N'},
  {id:'victor',name:'Victor',color:'i-victor',initial:'V'},
];

/* ---------- HELPERS ---------- */
function ensureSeed(id){
  const ch=ST.chats[id];
  if(ch.seeded) return;
  const sc=Scripts[id];
  if(sc?.start){ ch.pending.push({...sc.start}); ch.seeded=true; }
  save();
}

/* ---------- UI ---------- */
function AppBar(){
  return (
    <div className="appbar">
      <button className="btn-top" onClick={hardReset}>Reset</button>
      <b>Heartline</b>
      <div style={{width:'60px'}}/>
    </div>
  );
}

/* Start screen */
function StartScreen(){
  return (
    <div className="screen">
      <div className="start-wrap">
        <div className="card">
          <div className="title">Heartline</div>
          <div style="font-size:13px;color:#374151;margin-bottom:10px">Romance Messenger ‚Ä¢ Demo</div>
          <button className="btn-primary" onClick={()=>{ST.screen='name'; save(); render();}}>Start</button>
          <button className="btn-ghost" onClick={hardReset}>Reset save</button>
        </div>
      </div>
    </div>
  );
}

/* Name screen */
function NameScreen(){
  let inputRef=null;
  const setAndGo=()=>{
    const v=(inputRef?.value||'').trim()||'Player';
    ST.playerName=v;
    ST.screen='home';
    save(); render();
  };
  return (
    <div className="screen">
      <div className="start-wrap">
        <div className="card name-box">
          <div className="title" style={{fontSize:22}}>Welcome!</div>
          <div style="font-size:13px;color:#374151;margin:8px 0 10px">Enter your name (it will appear in chats):</div>
          <input placeholder="Your name" autofocus onKeydown={(e)=>{if(e.key==='Enter') setAndGo();}} ref={el=>inputRef=el}/>
          <button className="btn-primary" onClick={setAndGo}>OK</button>
        </div>
      </div>
    </div>
  );
}

/* Home screen */
function Home(){
  const total=Object.values(ST.unread).reduce((a,b)=>a+b,0);
  const openMessages=()=>{
    ST.screen='messages';
    ensureSeed('maja');                   // pierwsza rozmowa od Mai
    ST.unread.maja=(ST.unread.maja||0)+1; // badge
    save(); render();
  };
  const apps=[
    ['Messages','üí¨',openMessages],['Phone','üìû'],['Gallery','üñºÔ∏è'],
    ['Clock','‚è∞'],['Settings','‚öôÔ∏è'],['Notes','üìù'],
    ['Music','üéµ'],['Calendar','üìÖ'],['Mail','‚úâÔ∏è']
  ];
  return (
    <div className="screen">
      <div className="home">
        <div className="welcome">Welcome, {ST.playerName||'Player'} üíñ</div>
        <div className="grid">
          {apps.map(([n,i,fn])=>(
            <button key={n} className="app" onClick={()=>fn && fn()}>
              <div className="app-icon">{i}</div>
              {n==='Messages' && total>0 && <div className="badge">{total}</div>}
              <div className="app-name">{n}</div>
            </button>
          ))}
        </div>
        <div className="home-hint">Tap ‚ÄúMessages‚Äù to open chats</div>
      </div>
    </div>
  );
}

/* Messages list */
function Messages(){
  const visible=Object.keys(ST.unlocked).filter(id=>ST.unlocked[id]).map(id=>CONTACTS.find(c=>c.id===id));
  const last=(id)=>{
    const m=ST.chats[id]?.messages||[];
    return m.length? m[m.length-1].text : (Scripts[id]?.start?.text || '');
  };
  const openChat=(id)=>{
    ensureSeed(id);
    ST.current=id;
    ST.screen='chat';
    ST.unread[id]=0;
    save(); render();
  };
  return (
    <div className="messages">
      <div className="topbar">
        <button className="btn" onClick={()=>{ST.screen='home'; save(); render();}}>‚óÄ Home</button>
        <div style={{fontWeight:700}}>Messages</div>
        <div style={{width:24}}/>
      </div>
      <div className="list">
        {visible.map(c=>(
          <button key={c.id} className="contact" onClick={()=>openChat(c.id)}>
            <div className={'initial '+c.color}>{c.initial}</div>
            <div><div className="name">{c.name}</div><div className="last">{last(c.id)}</div></div>
            {(ST.unread[c.id]||0)>0 && <div className="badge badge-row">{ST.unread[c.id]}</div>}
          </button>
        ))}
      </div>
    </div>
  );
}

/* Chat */
function Chat(){
  const id=ST.current;
  const contact=CONTACTS.find(c=>c.id===id);
  const ch=ST.chats[id];

  // NEXT: z kolejki -> na ekran
  function stepNext(){
    if(!ch.pending.length) return;
    const msg=ch.pending.shift();
    ch.messages.push(msg);
    // po wy≈õwietleniu startu ‚Äî poka≈º wybory (tylko raz)
    if(ch.pending.length===0 && !ch.introDone && ch.seeded){
      ch.choices=(Scripts[id]?.choices)||[];
    }
    save(); render();
  }

  // WYB√ìR
  function choose(cid){
    const sc=Scripts[id];
    const pick=(sc.choices||[]).find(x=>x.id===cid);
    if(!pick) return;
    ch.messages.push({from:'You',text:pick.text,me:true});
    ch.choices=[];            // schowaj wybory
    ch.introDone=true;        // ju≈º nie pokazywaƒá przy ponownym wej≈õciu
    ch.pending.push(...((sc.replies||{})[cid]||[]));
    applyEffects((sc.effects||{})[cid]||[]); // np. odblokuj Rivena
    save(); render();
  }

  // FOLLOW-UP Riven ‚Äî tylko raz, gdy sko≈ÑczƒÖ siƒô pending + ju≈º by≈Ç intro
  if(id==='riven' && ch.introDone && !ch.followDone && ch.pending.length===0 && ch.choices.length===0){
    ch.choices=Scripts.riven.followupChoices;
    save();
  }
  function chooseFollow(cid){
    const sc=Scripts.riven;
    const pick=(sc.followupChoices||[]).find(x=>x.id===cid);
    if(!pick) return;
    ch.messages.push({from:'You',text:pick.text,me:true});
    ch.choices=[];
    ch.followDone=true;                   // nie pokazuj ponownie
    ch.pending.push(...(sc.followupReplies[cid]||[]));
    applyEffects((sc.effects||{})[cid]||[]);
    save(); render();
  }

  const onChoose=(cid)=>{
    if(id==='riven' && ['rfx1','rfx2','rfx3'].includes(cid)) chooseFollow(cid);
    else choose(cid);
  };

  return (
    <div className="messages">
      <div className="topbar">
        <button className="btn" onClick={()=>{ST.screen='messages'; save(); render();}}>Back</button>
        <div style={{fontWeight:700}}>{contact.name}</div>
        <div className={'initial-sm '+contact.color} style={{width:24,height:24}}>{contact.initial}</div>
      </div>

      <div className="chat">
        {ch.messages.map((m,i)=>(
          <div key={i} className="rowmsg" style={{justifyContent:m.me?'flex-end':'flex-start'}}>
            {!m.me && <div className={'initial-sm '+contact.color}>{(m.from||'?')[0]}</div>}
            <div className={'bubble '+(m.me?'from-me':'from-them')}>
              <div className="sender">{m.me?'You':m.from}</div>
              <div>{m.text.replace('[MC]', ST.playerName||'you')}</div>
            </div>
          </div>
        ))}
      </div>

      {ch.pending.length>0
        ? <div className="nextbar"><button className="btn-top" onClick={stepNext}>Next ‚ñ∂</button></div>
        : <div className="choices">
            {ch.choices.length
              ? ch.choices.map(c=><button key={c.id} className="choice" onClick={()=>onChoose(c.id)}>{c.text}</button>)
              : <div style={{fontSize:12,color:'#6b7280'}}>No new messages‚Ä¶</div>}
          </div>}
    </div>
  );
}

/* ---------- ROOT ---------- */
function App(){
  return (
    <div className="stage">
      <div className="phone">
        <AppBar/>
        {ST.screen==='start' && <StartScreen/>}
        {ST.screen==='name'  && <NameScreen/>}
        {ST.screen==='home'  && <Home/>}
        {ST.screen==='messages' && <Messages/>}
        {ST.screen==='chat' && <Chat/>}
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
function render(){ root.render(<App/>); }
render();
</script>
</body>
</html>
